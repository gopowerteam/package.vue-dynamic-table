name: CI

on:
  push:
    branches:
      - master
jobs:
  publish:
      name: Create NPM Publish
      timeout-minutes: 15
      runs-on: ubuntu-latest
      steps:
        - name: Checkout Code
          uses: actions/checkout@v3

        - name: Setup pnpm
          uses: pnpm/action-setup@v2.0.1
          with:
            version: ^7.0

        - name: Setup Node
          uses: actions/setup-node@v3
          with:
            node-version: 18
            cache: 'pnpm'


        - name: Setup pnpm cache
          uses: actions/cache@v3
          with:
            path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
            key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
            restore-keys: |
              ${{ runner.os }}-pnpm-store-

        - name: Install dependencies
          run: pnpm install

        - name: Build Packages
          run: pnpm run build

        - name: Set NPM TOKEN
          run: |
            git update-index --skip-worktree -- .npmrc
            pnpm config set '//registry.npmjs.org/:_authToken' "${NPM_TOKEN}"
          env:
            NPM_TOKEN: ${{secrets.NPM_TOKEN}}

        # 这一步是最重要的。使用changesets/action自动创建 PR 或者发布
        - name: Create Release Pull Request or Publish
          id: changesets
          uses: changesets/action@v1
          with:
            # 执行更新版本和发布的命令
            version: pnpm cs:version
            publish: pnpm cs:publish
            commit: '[ci] release'
            title: '[ci] release'
          env:
            # GITHUB_TOKEN 是 CI 里自带的默认 token
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            # NPM_TOKEN 需要稍后在 npm 网站生成。
            NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

